---
title: "Field-level Completeness/Frequency"
author: "Project Team 2"
date: "2024-06-06"
output: html_document
---

#Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here) 
library(geojsonR) 
library(sf) 
library(leaflet)
```

## Loading Data

```{r}
data_file_path <- here('data', 'aggregate_data.csv')
data <- read_csv(data_file_path)

geo_file_path <- here('data', 'jurisdiction_sf.geojson')
geo_data <- st_read(geo_file_path)

geo_data <- geo_data %>%  
  rename(system = sys_abbr)
```

#Fixing system N/A values
```{r}
data <- data %>%
  separate(file, into = c("press_release_system", "press_release", "year"), sep = "_") %>%
  mutate(c_system_abbr = case_when(
    is.na(c_system_abbr) ~ press_release_system,
    TRUE ~ c_system_abbr
  ))

data %>% 
  filter(is.na(c_system_abbr))
```

#DCRA required fields 
1. Decedent's name
2. Date of birth
3. Gender
4. Race 
5. Ethnicity
6. Date of death 
7. Time of death
8. Location of death
9. Law enforcement/correctional agency involved
10. Description of death (narrative and cause of death) 

```{r}
dcra_variables <- c("c_system_abbr", "c_ind_full_name", "c_ind_dob_year", "c_ind_gender", "c_ind_race", "c_ind_ethnicity", "c_ind_dod_ymd", "ind_tod", "ind_deathloc", "c_ind_fachoused", "c_ind_cod_type")
```

#DCRA required fields dataset
```{r}
#selected dataset variables based on DCRA required fields 
data <- data %>%  
  mutate(c_ind_first = 
           case_when(
             c_ind_first == "N/A" ~ NA, 
             TRUE ~ c_ind_first),
         c_ind_last = 
           case_when(
             c_ind_last == "N/A" ~ NA,
             TRUE ~ c_ind_last)
  )

dcra_dataset <- data %>% 
  mutate(c_ind_full_name = ifelse(!is.na(c_ind_first) & !is.na(c_ind_last),
                                  paste(c_ind_first, " ", c_ind_last), 
                                  NA)) %>% 
  select(all_of(dcra_variables))
```

#Total present data percentage by system and DCRA field  
```{r}
#computes the percentage of present data values for each system 
threshold <- 90 

dcra_table_system <- dcra_dataset %>% 
  group_by(c_system_abbr) %>% 
  summarize(
    present_data = sum(!is.na(across(everything()))),
    total_data = n() * (ncol(.) - 1),
    total_present_percent = round((present_data/total_data) * 100, 2)
  ) %>% 
  rename(system = c_system_abbr) %>% 
  select(system, total_present_percent) %>% 
  mutate(present = case_when(
    total_present_percent > threshold ~ "Present", 
    TRUE ~ "Missing"
  ))
dcra_table_system

dcra_table_system %>% 
  count(present) 
```

#Total present data percentage by DCRA field 
```{r} 
#computes the percentage of present data values for each DCRA field 
dcra_table_field <- dcra_dataset %>% 
  summarize(across(everything(), ~round(mean(!is.na(.)) * 100, 2))) %>% 
  select(all_of(c(dcra_variables))) %>% 
  pivot_longer(everything(), names_to = "variables", values_to = "total_present_percent") 
dcra_table_field

new <- dcra_dataset %>% 
  summarize(across(everything(), ~round(mean(!is.na(.)) * 100, 2))) %>% 
  select(!c_system_abbr) %>% 
  rename(Name = c_ind_full_name, 
         Age = c_ind_dob_year,
         Gender = c_ind_gender,
         Race = c_ind_race, 
         Ethnicity = c_ind_ethnicity,
         Facility = c_ind_fachoused, 
         `Location of Death` = ind_deathloc,
         `Time of Death` = ind_tod, 
         `Date of Death` = c_ind_dod_ymd, 
         `Cause of Death` = c_ind_cod_type) %>% 
  pivot_longer(everything(), names_to = "Field", values_to = "Percentage of Present Data")
new


```

#Total present data percentage by DCRA field grouping (demographics, cause of death, context) 
```{r} 
#computes the percentage of present data values for each DCRA field grouping 
demographic_variables <- c("c_ind_full_name", "c_ind_dob_year", "c_ind_gender", "c_ind_race", "c_ind_ethnicity") 
cod_variables <- c("c_ind_cod_type") 
context_variables <- c("c_ind_dod_ymd", "ind_tod", "ind_deathloc", "c_ind_fachoused") 

dcra_table_field_grouping <- dcra_dataset %>% 
  rowwise() %>% 
  mutate(present_demographic = sum(!is.na(across(all_of(demographic_variables))))/length(demographic_variables) * 100,
         cod_variables = sum(!is.na(across(all_of(cod_variables))))/length(cod_variables) * 100, 
         context_variables = sum(!is.na(across(all_of(context_variables))))/length(context_variables) * 100) %>% 
  ungroup() %>% 
  summarize(present_demographic = round(mean(present_demographic, na.rm = TRUE), 2), 
            present_cod_variables = round(mean(cod_variables, na.rm = TRUE), 2), 
            present_context_variables = round(mean(context_variables, na.rm = TRUE), 2)) 
dcra_table_field_grouping 
```

#Present data percentage for each variable by system
```{r}
#computes the percentage of present data values for each variable for each system 
dcra_table_variable <- dcra_dataset %>% 
  group_by(c_system_abbr) %>% 
  summarize(across(everything(), ~ round(mean(!is.na(.)) * 100, 2))) %>% 
  select(all_of(c(dcra_variables))) %>% 
  rename(system = c_system_abbr)
dcra_table_variable

dcra_table_variable_longer <- dcra_table_variable %>% 
  right_join(geo_data, join_by(system==system)) %>% 
  mutate_if(is.numeric, coalesce, 0) %>% 
  select(c("system", "c_ind_full_name", "c_ind_dob_year", "c_ind_gender", "c_ind_race", "c_ind_ethnicity", "c_ind_dod_ymd", "ind_tod", "ind_deathloc", "c_ind_fachoused", "c_ind_cod_type")) %>% 
  pivot_longer(!system, names_to = "variable", values_to = "percentages") 
dcra_table_variable_longer
```

#Bar Graph Data Cleaning
```{r}
threshold <- 90

dcra_table_variable_bar_cleaned <- dcra_table_variable %>% 
  mutate(c_ind_full_name = 
           case_when(
             c_ind_full_name > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_dob_year = 
           case_when(
             c_ind_dob_year > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_gender = 
           case_when(
             c_ind_gender > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_race = 
           case_when(
             c_ind_race > threshold ~ "Present",
             TRUE ~ "Missing"),
         c_ind_ethnicity = 
           case_when(
             c_ind_ethnicity > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_dod_ymd = 
           case_when(
             c_ind_dod_ymd > threshold ~ "Present", 
             TRUE ~ "Missing"),
         ind_tod = 
           case_when(
             ind_tod > threshold ~ "Present", 
             TRUE ~ "Missing"),
         ind_deathloc = 
           case_when(
             ind_deathloc > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_fachoused = 
           case_when(
             c_ind_fachoused > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_cod_type = 
           case_when(
             c_ind_cod_type > threshold ~ "Present", 
             TRUE ~ "Missing"),
         )
dcra_table_variable_bar_cleaned
```

#Bar Graph Dataset
```{r} 
#computes the number of systems with present/missing data for a given variable (based on 90% threshold) 
dcra_table_variable_bar <- dcra_table_variable_bar_cleaned %>% 
  pivot_longer(cols = !system, names_to = "variable", values_to = "present") %>% 
  filter(present == "Present") %>% 
  group_by(variable) %>% 
  summarize(present = n(),
            missing = 54 - present) %>% 
  ungroup() 
dcra_table_variable_bar

field_mapping <- c(
  'c_ind_cod_type' = 'Cause of Death',
  'c_ind_dob_year' = 'Age', 
  'c_ind_dod_ymd' = 'Date of Death',
  'c_ind_ethnicity' = 'Ethnicity',
  'c_ind_fachoused' = 'Facility',
  'c_ind_full_name' = 'Name',
  'c_ind_gender' = 'Gender',
  'c_ind_race' = 'Race',
  'ind_deathloc' = 'Location of Death',
  'ind_tod' = 'Time of Death'
)

dcra_table_variable_bar_renamed <- dcra_table_variable_bar %>% 
  mutate(variable = recode(variable, !!!field_mapping))
dcra_table_variable_bar_renamed

#computes the percentage of systems with present data for a given variable (based on 90% threshold) 
dcra_table_variable_bar_percentage <- dcra_table_variable_bar %>% 
  mutate(present_percentage = round(present/(present + missing) * 100, 2))
dcra_table_variable_bar_percentage
```

#Bar Graph NEW
```{r}
#bar graph for the available DCRA required field data (present/missing based on 90% threshold) in press releases 
dcra_table_variable_bar_renamed %>% 
  pivot_longer(!variable, names_to = "status", values_to = "count") %>% 
  filter(status == "present") %>% 
  arrange(status) %>% 
  mutate(variable = factor(variable, levels = variable[order(count)])) %>% 
  ggplot(aes(x = count, y = variable)) + 
  geom_bar(stat = "identity", fill = "#b8d8f0ff") + 
  geom_text(aes(label = count), position = position_stack(vjust = 0.5), color = "black", size = 4) + 
  labs(title = "Majority of Systems Don't Meet DCRA Field Requirements in Press Releases", 
       caption = "DCRA required field data availability determined by a >50%\nthreshold, meaning across all press releases for a given system,\nthe data is present for at least 90% of those press releases", 
       x = "Total number of systems", 
       y = "Required DCRA prison mortality field", 
       fill = "Availability for DCRA field") + 
  theme_minimal() + 
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50), limits = c(0, 55)) + 
  theme(axis.title.y = element_text(margin = margin(r = 20)))
```

#Bar Graph OLD
```{r}
#bar graph for the available DCRA required field data (present/missing based on 90% threshold) in press releases 
dcra_table_variable_bar %>% 
  pivot_longer(!variable, names_to = "status", values_to = "count") %>% 
  mutate(variable = factor(variable, levels = c("c_ind_full_name", "c_ind_dob_year", "c_ind_gender", "c_ind_race", "c_ind_ethnicity", "c_ind_fachoused", "ind_deathloc", "c_ind_dod_ymd", "ind_tod", "c_ind_cod_type"))) %>% 
  ggplot(aes(x = count, y = variable, fill = status)) +
  geom_bar(position = "stack", stat = "identity") + 
  geom_text(aes(label = count), position = position_stack(vjust = 0.5), color = "black", size = 4) + 
  labs(title = "Majority of Systems Don't Meet DCRA Field Requirements in Press Releases", 
        caption = "DCRA required field data availability determined by a >50% \nthreshold, meaning across all press releases for a given system, \nthe data is present for at least 90% of those press releases ",
        x = "Total number of systems",
        y = "Required DCRA prison mortality field",
        fill = "Availability for DCRA field") + 
  theme_minimal() + 
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50), limits = c(0, 55)) + 
  scale_fill_manual(values = c("#bcf6bcff", "#b8d8f0ff"), labels = c("Missing", "Present")) + 
  scale_y_discrete(labels = c("Name", "Age", "Gender", "Race", "Ethnicity", "Facility", "Location of Death", "Date of Death", "Time of Death", "Cause of Death")) + 
  theme(axis.title.y = element_text(margin = margin(r = 20))) 
```

#Join
```{r}
joined_agg_variable <- dcra_table_variable %>%  
  right_join(geo_data, join_by(system==system)) %>% 
  mutate_if(is.numeric,coalesce,0)
joined_agg_variable

joined_agg_system <- dcra_table_system %>% 
  right_join(geo_data, join_by(system==system)) %>% 
  mutate_if(is.numeric, coalesce, 0) 
joined_agg_system

joined_agg_present <- dcra_table_variable_bar_cleaned %>% 
  right_join(geo_data, join_by(system==system)) %>% 
  mutate_if(is.numeric, coalesce, 0) 
joined_agg_present

pie_present_variables <- joined_agg_present %>% 
  select(c("c_ind_full_name", "c_ind_dob_year", "c_ind_gender", "c_ind_race", "c_ind_ethnicity", "c_ind_dod_ymd", "ind_tod", "ind_deathloc", "c_ind_fachoused", "c_ind_cod_type"))  
pie_present_variables[is.na(pie_present_variables)] <- "No Data"
pie_present_variables
  
```

#Write to file/Testing 
```{r}
here() 
dcra_table_variable_longer %>% 
  write_csv(here("dcra_table_variable.csv"))

here() 
pie_present_variables %>% 
  write_csv(here("dcra_table_variable_pie.csv")) 

here()
joined_agg_variable %>%  
  st_write(here("dcra_field_completeness.geojson"), delete_dsn = T)

here()
joined_agg_system %>%  
  st_write(here("dcra_comprehensive_field_completeness.geojson"), delete_dsn = T)

here() 
joined_agg_present %>% 
  st_write(here("dcra_field_completeness_present.geojson"), delete_dsn = T) 


#write_csv(joined_agg_bar, here("dcra_field_completeness_bar.csv"))
#write_csv(dcra_table_variable_bar, here("dcra_field_completeness_count.csv")) 
```