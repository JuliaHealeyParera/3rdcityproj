---
title: "Field-Level Completeness/Frequency"
author: "Amy Duan"
date: "2024-06-06"
output: html_document
---

#Library Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here) 
library(geojsonR) 
library(sf) 
library(leaflet)
library(gt) 
library(geojsonR)
library(ggforce)
library(patchwork)
library(cowplot) 
library(webshot2)
```

## Loading Data
```{r}
data_file_path <- here('data', 'aggregate_data.csv')
data <- read_csv(data_file_path)

geo_file_path <- here('data', 'jurisdiction_sf.geojson')
geo_data <- st_read(geo_file_path)

st_crs(geo_data)

geo_data <- geo_data %>%  
  rename(system = sys_abbr)
```

#Fixing system N/A values
```{r}
data <- data %>% 
  mutate(
    press_release_system = case_when(
      c_collection_type != "Webscrape Table" ~ str_split_fixed(file, "_", 3)[, 1],
      TRUE ~ NA_character_
    )
  ) %>% 
  mutate(
    c_system_abbr = case_when(
      c_collection_type != "Webscrape Table" & is.na(c_system_abbr) ~ press_release_system,
      TRUE ~ c_system_abbr
    )
  )
```

#DCRA required fields 
1. Decedent's name
2. Date of birth
3. Gender
4. Race 
5. Ethnicity
6. Date of death 
7. Time of death
8. Location of death
9. Law enforcement/correctional agency involved
10. Description of death (narrative and cause of death) 

```{r}
dcra_variables <- c("c_system_abbr", "c_ind_full_name", "c_ind_dob_year", "c_ind_gender", "c_ind_race", "c_ind_ethnicity", "c_ind_dod_ymd", "ind_tod", "ind_deathloc", "c_ind_fachoused", "c_ind_cod_avail")
```

#DCRA required fields dataset
```{r}
#Creates a column for decedent's full name 
data <- data %>%  
  mutate(c_ind_first = 
           case_when(
             c_ind_first == "N/A" ~ NA, 
             TRUE ~ c_ind_first),
         c_ind_last = 
           case_when(
             c_ind_last == "N/A" ~ NA,
             TRUE ~ c_ind_last)
  )

dcra_dataset <- data %>% 
  mutate(c_ind_full_name = ifelse(!is.na(c_ind_first) & !is.na(c_ind_last),
                                  paste(c_ind_first, " ", c_ind_last), 
                                  NA),
         c_ind_cod_avail = ifelse(c_ind_cod_avail != "Listed", NA, c_ind_cod_avail)) %>% 
  select(all_of(dcra_variables))
```

#Total present data percentage by system and DCRA field  
```{r}
#computes the percentage of present data values for each system based on a 90% threshold
threshold <- 90 

dcra_table_system <- dcra_dataset %>% 
  group_by(c_system_abbr) %>% 
  summarize(
    present_data = sum(!is.na(across(everything()))),
    total_data = n() * (ncol(.) - 1),
    total_present_percent = round((present_data/total_data) * 100, 2)
  ) %>% 
  rename(system = c_system_abbr) %>% 
  select(system, total_present_percent) %>% 
  mutate(present = case_when(
    total_present_percent > threshold ~ "Present", 
    TRUE ~ "Missing"
  ))
dcra_table_system

#computes the count of systems that have present comprehensive data based on a 90% threshold
dcra_table_system %>% 
  count(present) 
```

#Total present data percentage by DCRA field - VISUALIZATION 
```{r} 
#computes the percentage of present data values for each DCRA field 
dcra_table_field <- dcra_dataset %>% 
  summarize(across(everything(), ~round(mean(!is.na(.)) * 100, 2))) %>% 
  select(all_of(c(dcra_variables))) %>% 
  pivot_longer(everything(), names_to = "variables", values_to = "total_present_percent") %>% 
  mutate(description = 
           case_when(
             variables == "c_ind_full_name" ~ "Name of the decedent (first and last)",
             variables == "c_ind_race" ~ "Race of the decedent", 
             variables == "c_ind_gender" ~ "Gender of the decedent", 
             variables == "c_ind_dob_year" ~ "Age of the decedent at date of death", 
             variables == "c_ind_ethnicity" ~ "Ethnicity of the decedent", 
             variables == "c_ind_fachoused" ~ "Facility in which the decedent was housed", 
             variables == "ind_tod" ~ "Time at which the decedent passed", 
             variables == "c_ind_dod_ymd" ~ "Date on which the decedent passed",
             variables == "ind_deathloc" ~ "Location in which the decedent passed", 
             variables == "c_ind_cod_avail" ~ "Cause of death availability by which the decedent passed",
             TRUE ~ NA
           )
         )
dcra_table_field <- dcra_table_field %>% 
  rename(`Field Name` = variables, 
         `Present Data Across All Press Releases` = total_present_percent, 
         `Description` = description) %>% 
  filter(`Field Name` != "c_system_abbr")
dcra_table_field

#creates dashboard table for DCRA required fields 
new <- dcra_dataset %>% 
  summarize(across(everything(), ~round(mean(!is.na(.)) * 100, 2))) %>% 
  select(!c_system_abbr) %>% 
  rename(Name = c_ind_full_name, 
         Age = c_ind_dob_year,
         Gender = c_ind_gender,
         Race = c_ind_race, 
         Ethnicity = c_ind_ethnicity,
         Facility = c_ind_fachoused, 
         `Location of Death` = ind_deathloc,
         `Time of Death` = ind_tod, 
         `Date of Death` = c_ind_dod_ymd, 
         `Cause of Death Availability` = c_ind_cod_avail) %>% 
  pivot_longer(everything(), names_to = "Field", values_to = "Present Data (Percentage)") %>% 
  mutate(Description = 
           case_when(
             Field == "Name" ~ "Name of the decedent (first and last)",
             Field == "Race" ~ "Race of the decedent", 
             Field == "Gender" ~ "Gender of the decedent", 
             Field == "Age" ~ "Age of the decedent at date of death", 
             Field == "Ethnicity" ~ "Ethnicity of the decedent", 
             Field == "Facility" ~ "Facility in which the decedent was housed", 
             Field == "Time of Death" ~ "Time at which the decedent passed", 
             Field == "Date of Death" ~ "Date on which the decedent passed",
             Field == "Location of Death" ~ "Location in which the decedent passed", 
             Field == "Cause of Death Availability" ~ "Cause of death availability by which the decedent passed",
             TRUE ~ NA
           )
         ) %>% 
  mutate(field_grouping = 
           case_when(
             Field == "Cause of Death Availability" ~ "Cause of Death",
             Field == "Name" ~ "Demographic",
             Field == "Race" ~ "Demographic", 
             Field == "Gender" ~ "Demographic", 
             Field == "Age" ~ "Demographic", 
             Field == "Ethnicity" ~ "Demographic", 
             Field == "Facility" ~ "Context", 
             Field == "Time of Death" ~ "Context", 
             Field == "Date of Death" ~ "Context", 
             Field == "Location of Death" ~ "Context",
             TRUE ~ NA
           )
         ) %>% 
  rename(`Field Grouping` = field_grouping) %>% 
  select(Field, Description, `Present Data (Percentage)`, `Field Grouping`) %>% 
  relocate(Description, .before = `Present Data (Percentage)`) %>% 
  mutate(`Present Data (Percentage)` = paste(`Present Data (Percentage)`, "%", sep = ""))

table_visualization_wo_title <- new %>% 
  gt() %>% 
  tab_style(
    style = cell_fill(color = "#d0d1e6"), 
    locations = cells_body(rows = `Field Grouping` == "Demographic")
  ) %>% 
  tab_style(
    style = cell_fill(color = "lightskyblue2"), 
    locations = cells_body(rows = `Field Grouping` == "Context") 
  ) %>% 
  tab_style(
    style = cell_fill(color = "darkseagreen1"), 
    locations = cells_body(rows = `Field Grouping` == "Cause of Death")
  ) %>% 
  cols_hide(column = vars(`Field Grouping`))

table_visualization <- table_visualization_wo_title %>% 
  tab_header(
    title = md("**Present DCRA Field Data Across All Press Releases**")
  ) 

table_visualization_wo_title
table_visualization
```

```{r}
path_wo_title <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "table_wo_title.png")
path_w_title <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "table_w_title.png") 

gtsave(data = table_visualization_wo_title, filename = path_wo_title)
gtsave(data = table_visualization, filename = path_w_title)
```

#Total present data percentage by DCRA field grouping (demographics, cause of death, context) - VISUALIZATION 
```{r} 
#computes the percentage of present data values for each DCRA field grouping 
demographic_variables <- c("c_ind_full_name", "c_ind_dob_year", "c_ind_gender", "c_ind_race", "c_ind_ethnicity") 
cod_variables <- c("c_ind_cod_avail") 
context_variables <- c("c_ind_dod_ymd", "ind_tod", "ind_deathloc", "c_ind_fachoused") 

dcra_table_field_grouping <- dcra_dataset %>% 
  rowwise() %>% 
  mutate(present_demographic = sum(!is.na(across(all_of(demographic_variables))))/length(demographic_variables) * 100,
         cod_variables = sum(!is.na(across(all_of(cod_variables))))/length(cod_variables) * 100, 
         context_variables = sum(!is.na(across(all_of(context_variables))))/length(context_variables) * 100) %>% 
  ungroup() %>% 
  summarize(present_demographic = round(mean(present_demographic, na.rm = TRUE), 2), 
            present_cod_variables = round(mean(cod_variables, na.rm = TRUE), 2), 
            present_context_variables = round(mean(context_variables, na.rm = TRUE), 2)) 
dcra_table_field_grouping 
```

#Present data percentage for each variable by system
```{r}
#computes the percentage of present data values for each variable for each system 
dcra_table_variable <- dcra_dataset %>% 
  group_by(c_system_abbr) %>% 
  summarize(
    total_pr = n(),
    across(c_ind_full_name:c_ind_cod_avail, ~ round(mean(!is.na(.)) * 100, 2))) %>% 
  rename(system = c_system_abbr)
dcra_table_variable

dcra_table_variable_longer <- dcra_table_variable %>% 
  right_join(geo_data, join_by(system==system)) %>% 
  mutate_if(is.numeric, coalesce, 0) %>% 
  select(c("system", "c_ind_full_name", "c_ind_dob_year", "c_ind_gender", "c_ind_race", "c_ind_ethnicity", "c_ind_dod_ymd", "ind_tod", "ind_deathloc", "c_ind_fachoused", "c_ind_cod_avail", "total_pr")) %>% 
  pivot_longer(c_ind_full_name:c_ind_cod_avail, names_to = "variable", values_to = "percentages") %>% 
  mutate(field_grouping = 
           case_when(
             variable == "c_ind_cod_avail" ~ "Cause of Death",
             variable == "c_ind_full_name" ~ "Demographic",
             variable == "c_ind_race" ~ "Demographic", 
             variable == "c_ind_gender" ~ "Demographic", 
             variable == "c_ind_dob_year" ~ "Demographic", 
             variable == "c_ind_ethnicity" ~ "Demographic", 
             variable == "c_ind_fachoused" ~ "Context", 
             variable == "ind_tod" ~ "Context", 
             variable == "ind_deathloc" ~ "Context", 
             variable == "c_ind_dod_ymd" ~ "Context",
             TRUE ~ NA
           ),
         n = round(total_pr*percentages / 100))

dcra_variable_mins <- dcra_table_variable_longer |> 
  group_by(system) |>
  slice(which.min(percentages)) |> 
  select(system, variable, percentages) |>
  rename(min_variable = variable, 
         min_percentage = percentages)

dcra_table_variable_longer <- left_join(dcra_table_variable_longer, dcra_variable_mins)

dcra_table_variable_longer
```

#Present DCRA field count by system 
```{r} 
#computes the number of preset DCRA fields for each system 
dcra_table_variable_present_by_sys <- dcra_table_variable_longer %>% 
  select(system, variable, percentages) %>% 
  mutate(present = 
           case_when(
            percentages > 90 ~ "Present", 
            TRUE ~ "Missing" 
  )) %>% 
  filter(present == "Present") %>% 
  group_by(system) %>% 
  summarize(present = n(),
            missing = 10 - present)
dcra_table_variable_present_by_sys
```

#Completeness of Individual Death Data 
```{r}
#determines the data completeness for each system based on the 90% threshold
dcra_table_variable_longer %>% 
  mutate(present_var = 
           case_when(
             percentages > 90 ~ "Present", 
             TRUE ~ "Missing"
    
            )
        ) %>% 
  group_by(system, present_var) %>%
  count() %>% 
  filter(present_var == "Present") %>% 
  mutate(almost_complete = 
           case_when(
             n >= 7 ~ "Yes", 
             TRUE ~ "No"
           ) 
         ) %>%
  ungroup() %>% 
  select(system, almost_complete)
```


#Bar/Chloropleth Graph Data Cleaning
```{r}
#cleans data for DCRA required fields bar chart
threshold <- 90

dcra_table_variable_bar_cleaned <- dcra_table_variable %>% 
  mutate(c_ind_full_name = 
           case_when(
             c_ind_full_name > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_dob_year = 
           case_when(
             c_ind_dob_year > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_gender = 
           case_when(
             c_ind_gender > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_race = 
           case_when(
             c_ind_race > threshold ~ "Present",
             TRUE ~ "Missing"),
         c_ind_ethnicity = 
           case_when(
             c_ind_ethnicity > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_dod_ymd = 
           case_when(
             c_ind_dod_ymd > threshold ~ "Present", 
             TRUE ~ "Missing"),
         ind_tod = 
           case_when(
             ind_tod > threshold ~ "Present", 
             TRUE ~ "Missing"),
         ind_deathloc = 
           case_when(
             ind_deathloc > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_fachoused = 
           case_when(
             c_ind_fachoused > threshold ~ "Present", 
             TRUE ~ "Missing"),
         c_ind_cod_avail = 
           case_when(
             c_ind_cod_avail > threshold ~ "Present", 
             TRUE ~ "Missing"),
         )
dcra_table_variable_bar_cleaned

dcra_table_variable_present_by_sys <- dcra_table_variable_bar_cleaned %>% 
  select(!total_pr) |>
  pivot_longer(cols = !system, names_to = "variable", values_to = "present") %>% 
  filter(present == "Present") %>% 
  group_by(system) %>% 
  summarize(present = n(),
            missing = 10 - present)
```

#Bar Graph/Chloropleth Graph Datasets
```{r} 
#computes the number of systems with present/missing data for a given variable (based on 90% threshold) 
dcra_table_variable_bar <- dcra_table_variable_bar_cleaned %>% 
  select(!total_pr) %>% 
  pivot_longer(cols = !system, names_to = "variable", values_to = "present") %>% 
  filter(present == "Present") %>% 
  group_by(variable) %>% 
  summarize(present = n(),
            missing = 54 - present) %>% 
  ungroup() %>% 
  mutate(field_grouping = 
           case_when(
             variable == "c_ind_cod_avail" ~ "Cause of Death",
             variable == "c_ind_full_name" ~ "Demographic",
             variable == "c_ind_race" ~ "Demographic", 
             variable == "c_ind_gender" ~ "Demographic", 
             variable == "c_ind_dob_year" ~ "Demographic", 
             variable == "c_ind_ethnicity" ~ "Demographic", 
             variable == "c_ind_fachoused" ~ "Context", 
             variable == "ind_tod" ~ "Context", 
             variable == "c_ind_dod_ymd" ~ "Context", 
             variable == "ind_deathloc" ~ "Context",
             TRUE ~ NA
           )
         )
dcra_table_variable_bar

field_mapping <- c(
  'c_ind_full_name' = 'Name',
  'c_ind_race' = 'Race',
  'c_ind_gender' = 'Gender',
  'c_ind_dob_year' = 'Age', 
  'c_ind_ethnicity' = 'Ethnicity',
  'c_ind_fachoused' = 'Facility',
  'ind_tod' = 'Time of Death',
  'c_ind_dod_ymd' = 'Date of Death',
  'ind_deathloc' = 'Location of Death',
  'c_ind_cod_avail' = 'Cause of Death'
)

dcra_table_variable_bar_renamed <- dcra_table_variable_bar %>% 
  mutate(variable = recode(variable, !!!field_mapping)) %>% 
  group_by(field_grouping) %>% 
  arrange(field_grouping, present) 
dcra_table_variable_bar_renamed

#computes the percentage of systems with present data for a given variable (based on 90% threshold) 
dcra_table_variable_bar_percentage <- dcra_table_variable_bar %>% 
  mutate(present_percentage = round(present/(present + missing) * 100, 2))
dcra_table_variable_bar_percentage
```

#DCRA Field Completeness Chloropleth Maps 

```{r}
joined_agg <- dcra_table_variable_bar_cleaned %>% 
  right_join(geo_data, join_by(system)) %>% 
  mutate_if(is.numeric, coalesce, 0)

joined_agg <- joined_agg %>% 
  mutate(c_ind_full_name = 
           case_when(
             is.na(c_ind_full_name) ~ "No Data", 
             TRUE ~ c_ind_full_name
           ),
         c_ind_dob_year = 
           case_when(
             is.na(c_ind_dob_year) ~ "No Data", 
             TRUE ~ c_ind_dob_year
           ),
         c_ind_gender = 
           case_when(
             is.na(c_ind_gender) ~ "No Data", 
             TRUE ~ c_ind_gender
           ),
         c_ind_race = 
           case_when(
             is.na(c_ind_race) ~ "No Data", 
             TRUE ~ c_ind_race
           ),
         c_ind_ethnicity = 
           case_when(
             is.na(c_ind_ethnicity) ~ "No Data",
             TRUE ~ c_ind_ethnicity
           ),
         c_ind_dod_ymd = 
           case_when(
             is.na(c_ind_dod_ymd) ~ "No Data",
             TRUE ~ c_ind_dod_ymd
           ),
         ind_tod = 
           case_when(
             is.na(ind_tod) ~ "No Data", 
             TRUE ~ ind_tod
           ),
         ind_deathloc = 
           case_when(
             is.na(ind_deathloc) ~ "No Data", 
             TRUE ~ ind_deathloc
           ),
         c_ind_fachoused = 
           case_when(
             is.na(c_ind_fachoused) ~ "No Data", 
             TRUE ~ c_ind_fachoused
           ),
         c_ind_cod_avail = 
           case_when(
             is.na(c_ind_cod_avail) ~ "No Data", 
             TRUE ~ c_ind_cod_avail
           )
  ) %>% 
  st_as_sf()
```

```{r}
#DCRA Field - Name 
plot1_wo_title <- joined_agg %>% 
  select(system, c_ind_full_name, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = c_ind_full_name)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) +
  scale_size_continuous(guide = "none", limits = c(0, 2.2810334)) +
  labs(fill = "DCRA Data Availability") +
  theme_void() + 
  annotate(
     geom = "text", x = -68, y = 37, 
     label = "DC", size = 3
   ) +
   annotate("segment", x = -71, xend = -73.00002, y =37, yend = 38.89985) +
   annotate(
     geom = "text", x = -68, y = 25, 
     label = "PR", size = 3
    ) +
    annotate("segment", x = -71, xend = -73.00001, y =25, yend = 27.00015) +
    annotate(
     geom = "text", x = -93.00017, y = 23, 
     label = "BOP", size = 3
    ) +
    annotate("segment", x = -93.00017, xend = -93.00017, y =24.18, yend = 27.00001) +
    annotate(
     geom = "text", x = -83.99985, y = 23, 
     label = "ICE", size = 3
    ) +
    annotate("segment", x = -86.99985, xend = -86.99985, y =24.18, yend = 27.00012) +
  theme(legend.position = "none") 

#DCRA Field - Date of Birth 
plot2_wo_title <- joined_agg %>% 
  select(system, c_ind_dob_year, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = c_ind_dob_year)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) + 
  scale_size_continuous(guide = "none", limits = c(0, 2.2810334)) + 
  labs(fill = "DCRA Date of Birth Data Availability") + 
  theme_void() +
  annotate(
     geom = "text", x = -68, y = 37, 
     label = "DC", size = 3
   ) +
   annotate("segment", x = -71, xend = -73.00002, y =37, yend = 38.89985) +
   annotate(
     geom = "text", x = -68, y = 25, 
     label = "PR", size = 3
    ) +
    annotate("segment", x = -71, xend = -73.00001, y =25, yend = 27.00015) +
    annotate(
     geom = "text", x = -93.00017, y = 23, 
     label = "BOP", size = 3
    ) +
    annotate("segment", x = -93.00017, xend = -93.00017, y =24.18, yend = 27.00001) +
    annotate(
     geom = "text", x = -83.99985, y = 23, 
     label = "ICE", size = 3
    ) +
    annotate("segment", x = -86.99985, xend = -86.99985, y =24.18, yend = 27.00012) +
  theme(legend.position = "none") 

#DCRA Field - Gender 
plot3_wo_title <- joined_agg %>% 
  select(system, c_ind_gender, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = c_ind_gender)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) + 
  scale_size_continuous(guide = "none", limits = c(0, 2.2810334)) + 
  labs(fill = "DCRA Gender Data Availability") + 
  theme_void() +
  annotate(
     geom = "text", x = -68, y = 37, 
     label = "DC", size = 3
   ) +
   annotate("segment", x = -71, xend = -73.00002, y =37, yend = 38.89985) +
   annotate(
     geom = "text", x = -68, y = 25, 
     label = "PR", size = 3
    ) +
    annotate("segment", x = -71, xend = -73.00001, y =25, yend = 27.00015) +
    annotate(
     geom = "text", x = -93.00017, y = 23, 
     label = "BOP", size = 3
    ) +
    annotate("segment", x = -93.00017, xend = -93.00017, y =24.18, yend = 27.00001) +
    annotate(
     geom = "text", x = -83.99985, y = 23, 
     label = "ICE", size = 3
    ) +
    annotate("segment", x = -86.99985, xend = -86.99985, y =24.18, yend = 27.00012) +
  theme(legend.position = "none") 

#DCRA Field - Race
plot4_wo_title <- joined_agg %>% 
  select(system, c_ind_race, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = c_ind_race)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) + 
  scale_size_continuous(guide = "none", limits = c(0, 2.2810334)) + 
  labs(fill = "DCRA Race Data Availability") + 
  theme_void() +
  annotate(
     geom = "text", x = -68, y = 37, 
     label = "DC", size = 3
   ) +
   annotate("segment", x = -71, xend = -73.00002, y =37, yend = 38.89985) +
   annotate(
     geom = "text", x = -68, y = 25, 
     label = "PR", size = 3
    ) +
    annotate("segment", x = -71, xend = -73.00001, y =25, yend = 27.00015) +
    annotate(
     geom = "text", x = -93.00017, y = 23, 
     label = "BOP", size = 3
    ) +
    annotate("segment", x = -93.00017, xend = -93.00017, y =24.18, yend = 27.00001) +
    annotate(
     geom = "text", x = -83.99985, y = 23, 
     label = "ICE", size = 3
    ) +
    annotate("segment", x = -86.99985, xend = -86.99985, y =24.18, yend = 27.00012) +
  theme(legend.position = "none") 

#DCRA Field - Ethnicity 
plot5_wo_title <- joined_agg %>% 
  select(system, c_ind_ethnicity, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = c_ind_ethnicity)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) + 
  scale_size_continuous(guide = "none", limits = c(0, 2.2810334)) + 
  labs(fill = "DCRA Ethnicity Data Availability") + 
  theme_void() +
  annotate(
     geom = "text", x = -68, y = 37, 
     label = "DC", size = 3
   ) +
   annotate("segment", x = -71, xend = -73.00002, y =37, yend = 38.89985) +
   annotate(
     geom = "text", x = -68, y = 25, 
     label = "PR", size = 3
    ) +
    annotate("segment", x = -71, xend = -73.00001, y =25, yend = 27.00015) +
    annotate(
     geom = "text", x = -93.00017, y = 23, 
     label = "BOP", size = 3
    ) +
    annotate("segment", x = -93.00017, xend = -93.00017, y =24.18, yend = 27.00001) +
    annotate(
     geom = "text", x = -83.99985, y = 23, 
     label = "ICE", size = 3
    ) +
    annotate("segment", x = -86.99985, xend = -86.99985, y =24.18, yend = 27.00012) +
  theme(legend.position = "none")
 
#DCRA Field - Date of Death 
plot6_wo_title <- joined_agg %>% 
  select(system, c_ind_dod_ymd, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = c_ind_dod_ymd)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) + 
  scale_size_continuous(guide = "none", limits = c(0, 2.2810334)) + 
  labs(fill = "DCRA Date of Death Data Availability") + 
  theme_void() +
  annotate(
     geom = "text", x = -68, y = 37, 
     label = "DC", size = 3
   ) +
   annotate("segment", x = -71, xend = -73.00002, y =37, yend = 38.89985) +
   annotate(
     geom = "text", x = -68, y = 25, 
     label = "PR", size = 3
    ) +
    annotate("segment", x = -71, xend = -73.00001, y =25, yend = 27.00015) +
    annotate(
     geom = "text", x = -93.00017, y = 23, 
     label = "BOP", size = 3
    ) +
    annotate("segment", x = -93.00017, xend = -93.00017, y =24.18, yend = 27.00001) +
    annotate(
     geom = "text", x = -83.99985, y = 23, 
     label = "ICE", size = 3
    ) +
    annotate("segment", x = -86.99985, xend = -86.99985, y =24.18, yend = 27.00012) +
  theme(legend.position = "none") 

#DCRA Field - Time of Death 
plot7_wo_title <- joined_agg %>% 
  select(system, ind_tod, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = ind_tod)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) + 
  scale_size_continuous(guide = "none", limits = c(0, 2.2810334)) + 
  labs(fill = "DCRA Time of Death Data Availability") + 
  theme_void() +
  annotate(
     geom = "text", x = -68, y = 37, 
     label = "DC", size = 3
   ) +
   annotate("segment", x = -71, xend = -73.00002, y =37, yend = 38.89985) +
   annotate(
     geom = "text", x = -68, y = 25, 
     label = "PR", size = 3
    ) +
    annotate("segment", x = -71, xend = -73.00001, y =25, yend = 27.00015) +
    annotate(
     geom = "text", x = -93.00017, y = 23, 
     label = "BOP", size = 3
    ) +
    annotate("segment", x = -93.00017, xend = -93.00017, y =24.18, yend = 27.00001) +
    annotate(
     geom = "text", x = -83.99985, y = 23, 
     label = "ICE", size = 3
    ) +
    annotate("segment", x = -86.99985, xend = -86.99985, y =24.18, yend = 27.00012) +
  theme(legend.position = "none") 

#DCRA Field - Location of Death
plot8_wo_title <- joined_agg %>% 
  select(system, ind_deathloc, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = ind_deathloc)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) + 
  scale_size_continuous(guide = "none", limits = c(0, 2.2810334)) + 
  labs(fill = "DCRA Location of Death Data Availability") + 
  theme_void() +
  annotate(
     geom = "text", x = -68, y = 37, 
     label = "DC", size = 3
   ) +
   annotate("segment", x = -71, xend = -73.00002, y =37, yend = 38.89985) +
   annotate(
     geom = "text", x = -68, y = 25, 
     label = "PR", size = 3
    ) +
    annotate("segment", x = -71, xend = -73.00001, y =25, yend = 27.00015) +
    annotate(
     geom = "text", x = -93.00017, y = 23, 
     label = "BOP", size = 3
    ) +
    annotate("segment", x = -93.00017, xend = -93.00017, y =24.18, yend = 27.00001) +
    annotate(
     geom = "text", x = -83.99985, y = 23, 
     label = "ICE", size = 3
    ) +
    annotate("segment", x = -86.99985, xend = -86.99985, y =24.18, yend = 27.00012) +
  theme(legend.position = "none")

#DCRA Field - Facility 
plot9_wo_title <- joined_agg %>% 
  select(system, c_ind_fachoused, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = c_ind_fachoused)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) + 
  scale_size_continuous(guide = "none", limits = c(0, 2.2810334)) + 
  labs(fill = "DCRA Facility Data Availability") + 
  theme_void() +
  annotate(
     geom = "text", x = -68, y = 37, 
     label = "DC", size = 3
   ) +
   annotate("segment", x = -71, xend = -73.00002, y =37, yend = 38.89985) +
   annotate(
     geom = "text", x = -68, y = 25, 
     label = "PR", size = 3
    ) +
    annotate("segment", x = -71, xend = -73.00001, y =25, yend = 27.00015) +
    annotate(
     geom = "text", x = -93.00017, y = 23, 
     label = "BOP", size = 3
    ) +
    annotate("segment", x = -93.00017, xend = -93.00017, y =24.18, yend = 27.00001) +
    annotate(
     geom = "text", x = -83.99985, y = 23, 
     label = "ICE", size = 3
    ) +
    annotate("segment", x = -86.99985, xend = -86.99985, y =24.18, yend = 27.00012) +
  theme(legend.position = "none") 

#DCRA Field - Cause of Death 
plot10_wo_title <- joined_agg %>% 
  select(system, c_ind_cod_avail, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = c_ind_cod_avail)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) + 
  scale_size_continuous(guide = "none", limits = c(0, 2.2810334)) + 
  labs(fill = "DCRA Cause of Death Data Availability") + 
  theme_void() +
  annotate(
     geom = "text", x = -68, y = 37, 
     label = "DC", size = 3
   ) +
   annotate("segment", x = -71, xend = -73.00002, y =37, yend = 38.89985) +
   annotate(
     geom = "text", x = -68, y = 25, 
     label = "PR", size = 3
    ) +
    annotate("segment", x = -71, xend = -73.00001, y =25, yend = 27.00015) +
    annotate(
     geom = "text", x = -93.00017, y = 23, 
     label = "BOP", size = 3
    ) +
    annotate("segment", x = -93.00017, xend = -93.00017, y =24.18, yend = 27.00001) +
    annotate(
     geom = "text", x = -83.99985, y = 23, 
     label = "ICE", size = 3
    ) +
    annotate("segment", x = -86.99985, xend = -86.99985, y =24.18, yend = 27.00012) +
  theme(legend.position = "none") 

plot1_wo_title
plot2_wo_title
plot3_wo_title
plot4_wo_title
plot5_wo_title
plot6_wo_title
plot7_wo_title
plot8_wo_title
plot9_wo_title
plot10_wo_title
```

```{r}
plot1_wo_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "name_chloropleth_wo_title.png")
plot2_wo_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "dob_chloropleth_wo_title.png")
plot3_wo_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "gender_chloropleth_wo_title.png")
plot4_wo_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "race_chloropleth_wo_title.png")
plot5_wo_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "ethnicity_chloropleth_wo_title.png")
plot6_wo_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "dod_chloropleth_wo_title.png")
plot7_wo_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "tod_chloropleth_wo_title.png")
plot8_wo_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "deathloc_chloropleth_wo_title.png")
plot9_wo_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "facility_chloropleth_wo_title.png")
plot10_wo_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "cod_chloropleth_wo_title.png")

ggsave(plot1_wo_title_path, plot = plot1_wo_title, width = 10, height = 8, dpi = 300)
ggsave(plot2_wo_title_path, plot = plot2_wo_title, width = 10, height = 8, dpi = 300)
ggsave(plot3_wo_title_path, plot = plot3_wo_title, width = 10, height = 8, dpi = 300)
ggsave(plot4_wo_title_path, plot = plot4_wo_title, width = 10, height = 8, dpi = 300)
ggsave(plot5_wo_title_path, plot = plot5_wo_title, width = 10, height = 8, dpi = 300)
ggsave(plot6_wo_title_path, plot = plot6_wo_title, width = 10, height = 8, dpi = 300)
ggsave(plot7_wo_title_path, plot = plot7_wo_title, width = 10, height = 8, dpi = 300)
ggsave(plot8_wo_title_path, plot = plot8_wo_title, width = 10, height = 8, dpi = 300)
ggsave(plot9_wo_title_path, plot = plot9_wo_title, width = 10, height = 8, dpi = 300)
ggsave(plot10_wo_title_path, plot = plot10_wo_title, width = 10, height = 8, dpi = 300)
```

```{r}
#DCRA Field - Name 
plot1 <- plot1_wo_title +
  labs(title = "48% (n = 23) of systems contain DCRA\nname data in press releases") +
  theme(plot.title = element_text(hjust = 0.5))

#DCRA Field - Date of Birth 
plot2 <- plot2_wo_title + 
  labs(title = "78% (n = 21) of systems contain DCRA\ndate of birth data in press releases") +
  theme(plot.title = element_text(hjust = 0.5))

#DCRA Field - Gender 
plot3 <- plot3_wo_title + 
  labs(title = "76% (n = 18) of systems contain DCRA\ngender data in press releases") +
  theme(plot.title = element_text(hjust = 0.5))

#DCRA Field - Race
plot4 <- plot4_wo_title + 
  labs(title = "82% (n = 30) of systems contain DCRA\nrace data in press releases") +
  theme(plot.title = element_text(hjust = 0.5))

#DCRA Field - Ethnicity 
plot5 <- plot5_wo_title + 
  labs(title = "10% (n = 19) of systems contain DCRA\nethnicity data in press releases") +
  theme(plot.title = element_text(hjust = 0.5))

#DCRA Field - Date of Death 
plot6 <- plot6_wo_title + 
  labs(title = "99.9% (n = 39) of systems contain DCRA\ndate of death data in press releases") +
  theme(plot.title = element_text(hjust = 0.5))

#DCRA Field - Time of Death 
plot7 <- plot7_wo_title +
  labs(title = "6% (n = 7) of systems contain DCRA\ntime of death data in press releases") +
  theme(plot.title = element_text(hjust = 0.5))

#DCRA Field - Location of Death
plot8 <- plot8_wo_title + 
  labs(title = "23% (n = 30) of systems contain DCRA\nlocation of death data in press releases") +
  theme(plot.title = element_text(hjust = 0.5))

#DCRA Field - Facility 
plot9 <- plot9_wo_title + 
  labs(title = "10% (n = 13) of systems contain DCRA\nfacility data in press releases") +
  theme(plot.title = element_text(hjust = 0.5))

#DCRA Field - Cause of Death 
plot10 <- plot10_wo_title + 
  labs(title = "77% (n = 16) of systems contain DCRA\ncause of death data in press releases") +
  theme(plot.title = element_text(hjust = 0.5))

plot1
plot2
plot3
plot4
plot5
plot6
plot7
plot8
plot9
plot10
```

```{r}
plot1_w_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "name_chloropleth_w_title.png")
plot2_w_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "dob_chloropleth_w_title.png")
plot3_w_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "gender_chloropleth_w_title.png")
plot4_w_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "race_chloropleth_w_title.png")
plot5_w_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "ethnicity_chloropleth_w_title.png")
plot6_w_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "dod_chloropleth_w_title.png")
plot7_w_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "tod_chloropleth_w_title.png")
plot8_w_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "deathloc_chloropleth_w_title.png")
plot9_w_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "facility_chloropleth_w_title.png")
plot10_w_title_path <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "cod_chloropleth_w_title.png")

ggsave(plot1_w_title_path, plot = plot1, width = 10, height = 8, dpi = 300)
ggsave(plot2_w_title_path, plot = plot2, width = 10, height = 8, dpi = 300)
ggsave(plot3_w_title_path, plot = plot3, width = 10, height = 8, dpi = 300)
ggsave(plot4_w_title_path, plot = plot4, width = 10, height = 8, dpi = 300)
ggsave(plot5_w_title_path, plot = plot5, width = 10, height = 8, dpi = 300)
ggsave(plot6_w_title_path, plot = plot6, width = 10, height = 8, dpi = 300)
ggsave(plot7_w_title_path, plot = plot7, width = 10, height = 8, dpi = 300)
ggsave(plot8_w_title_path, plot = plot8, width = 10, height = 8, dpi = 300)
ggsave(plot9_w_title_path, plot = plot9, width = 10, height = 8, dpi = 300)
ggsave(plot10_w_title_path, plot = plot10, width = 10, height = 8, dpi = 300)
```

```{r}
#DCRA Field - Name 
plot1 <- plot1 + 
  theme(plot.title = element_text(size = 8, hjust = 0.5))

#DCRA Field - Date of Birth 
plot2 <- plot2 + 
  theme(plot.title = element_text(size = 8, hjust = 0.5))

#DCRA Field - Gender 
plot3 <- plot3 + 
  theme(plot.title = element_text(size = 8, hjust = 0.5))

#DCRA Field - Race
plot4 <- plot4 + 
  theme(plot.title = element_text(size = 8, hjust = 0.5))

#DCRA Field - Ethnicity 
plot5 <- plot5 + 
  theme(plot.title = element_text(size = 8, hjust = 0.5))

#DCRA Field - Date of Death 
plot6 <- plot6 + 
  theme(plot.title = element_text(size = 8, hjust = 0.5))

#DCRA Field - Time of Death 
plot7 <- plot7 + 
  theme(plot.title = element_text(size = 8, hjust = 0.5))

#DCRA Field - Location of Death
plot8 <- plot8 + 
  theme(plot.title = element_text(size = 8, hjust = 0.5))

#DCRA Field - Facility 
plot9 <- plot9 + 
  theme(plot.title = element_text(size = 8, hjust = 0.5))

#DCRA Field - Cause of Death 
plot10 <- plot10 + 
  theme(plot.title = element_text(size = 8, hjust = 0.5))

plot1
plot2
plot3
plot4
plot5
plot6
plot7
plot8
plot9
plot10
```

```{r}
legend_plot <- joined_agg %>% 
  select(system, c_ind_full_name, geometry) %>% 
  ggplot() + 
  geom_sf(mapping = aes(geometry = geometry, fill = c_ind_full_name)) + 
  scale_fill_manual(values = c("#d0d1e6", "#a6bddb", "#f1eef6"), breaks = c("Present", "Missing", "No Data")) + 
  labs(fill = "DCRA Data Availability")
custom_legend <- get_legend(legend_plot) 
legend_plot

empty_plot <- ggplot() + theme_void() 

plot_wo_title <- plot1_wo_title + plot2_wo_title + plot3_wo_title + plot4_wo_title + plot5_wo_title + plot6_wo_title + plot7_wo_title + plot8_wo_title + plot9_wo_title + plot10_wo_title + plot_layout(ncol = 2, nrow = 5, heights = c(1, 1)) 
combined_chloropleth_plot_wo_title <- plot_grid(
  plot_wo_title, 
  plot_grid(empty_plot, custom_legend, empty_plot, ncol = 3, rel_widths = c(1, 2, 1)), 
  ncol = 1, 
  rel_heights = c(5, 1))
combined_chloropleth_plot_wo_title

plot <- plot1 + plot2 + plot3 + plot4 + plot5 + plot6 + plot7 + plot8 + plot9 + plot10 + plot_layout(ncol = 2, nrow = 5, heights = c(1, 1))
combined_chloropleth_plot <- plot_grid(
  plot, 
  plot_grid(empty_plot, custom_legend, empty_plot, ncol = 3, rel_widths = c(1, 2, 1)), 
  ncol= 1, 
  rel_heights = c(5,1))
combined_chloropleth_plot
```

```{r}
path_wo_title <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "chloropleth_wo_title.png")
path_w_title <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "chloropleth_w_title.png") 

save_plot(path_wo_title, combined_chloropleth_plot_wo_title, base_width = 10, base_height = 8, dpi = 300)
save_plot(path_w_title, combined_chloropleth_plot, base_width = 10, base_height = 8, dpi = 300)
```

#Bar Graph - VISUALIZATION 
```{r}
#bar graph for the available DCRA required field data (present/missing based on 90% threshold) in press releases 
colors <- c("Cause of Death" = "#94bea1", "Context" = "#a6bddb", "Demographic" = "#ccbee6")

bar <- dcra_table_variable_bar_renamed %>% 
  pivot_longer(!c(variable, field_grouping), names_to = "status", values_to = "count") %>% 
  filter(status == "present") %>% 
  group_by(field_grouping) %>% 
  arrange(field_grouping, count) %>% 
  mutate(variable = factor(variable, levels = unique(variable)))

bar_graph_wo_title <- bar %>% 
  ggplot(aes(x = count, y = variable, fill = field_grouping)) + 
  geom_bar(stat = "identity") + 
  scale_fill_manual(values = colors) + 
  geom_text(aes(label = count), position = position_stack(vjust = 0.5), color = "black", size = 4) + 
  labs(x = "Total Number of Systems", 
       y = "Required DCRA Prison Mortality Field", 
       fill = "DCRA Field Grouping") +
  theme_minimal() + 
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50), limits = c(0, 55)) + 
  theme(axis.title.y = element_text(margin = margin(r = 20)),
        plot.title = element_text(size = 14),
        panel.grid.major.y = element_blank(), 
        panel.grid.major.x = element_blank())
bar_graph_w_title <- bar_graph_wo_title + 
  labs(title = "Majority of Systems do not Meet DCRA Field\nRequirements in Press Releases", 
       caption = "DCRA required field data availability determined by a >90%\nthreshold, meaning across all press releases for a given system,\nthe data is present for at least 90% of those press releases") 

bar_graph_wo_title
bar_graph_w_title
```

```{r}
path_wo_title <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "bar_wo_title.png")
path_w_title <- here("working_doc_files", "dashboard_visualizations", "fieldlevel_completeness", "bar_w_title.png") 

ggsave(path_wo_title, plot = bar_graph_wo_title, width = 10, height = 8, dpi = 300)
ggsave(path_w_title, plot = bar_graph_w_title, width = 10, height = 8, dpi = 300)
```

#Join 
```{r}
joined_agg_variable <- dcra_table_variable %>%  
  right_join(geo_data, join_by(system==system)) %>% 
  mutate_if(is.numeric,coalesce,0)
joined_agg_variable

joined_agg_system <- dcra_table_system %>% 
  right_join(geo_data, join_by(system==system)) %>% 
  mutate_if(is.numeric, coalesce, 0) 
joined_agg_system

joined_agg_present <- dcra_table_variable_bar_cleaned %>% 
  right_join(geo_data, join_by(system==system)) %>% 
  mutate_if(is.numeric, coalesce, 0) 
joined_agg_present

pie_present_variables <- joined_agg_present %>% 
  select(c("c_ind_full_name", "c_ind_dob_year", "c_ind_gender", "c_ind_race", "c_ind_ethnicity", "c_ind_dod_ymd", "ind_tod", "ind_deathloc", "c_ind_fachoused", "c_ind_cod_avail"))  
pie_present_variables[is.na(pie_present_variables)] <- "No Data"
pie_present_variables
```

#Write to file/Testing 
```{r}
here() 
dcra_table_variable_longer %>% 
  write_csv(here("dcra_table_variable.csv"))

here() 
pie_present_variables %>% 
  write_csv(here("dcra_table_variable_pie.csv")) 

here()
joined_agg_variable %>%  
  st_write(here("dcra_field_completeness.geojson"), delete_dsn = T)

here()
joined_agg_present %>% 
  st_write(here("dcra_field_completeness_present.geojson"), delete_dsn = T) 

here() 
new %>% 
  write_csv(here("dcra_variable_present_data.csv"))

dcra_table_variable_present_by_sys %>% 
  write_csv("../data/dcra_table_variable_present_by_sys.csv")
```
