---
title: "data"
author: "Project Team 2"
date: "2024-05-21"
output: html_document
---

#Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
```

## Loading Data

```{r}
data <- read_csv("aggregate_data.csv")
head(data)
```

```{r}
agg_data |> 
  group_by(c_ind_cod_type) |>
  count()

agg_data_cod_covid <- agg_data |> 
  filter(c_ind_cod_type == "COVID-19")

agg_data_cod_covid |> 
  group_by(ind_deathloc) |>
  count()

agg_data |> 
  group_by(c_system_abbr) |> 
  count()
  
```

```{r}

private_manual_incomplete <- prisons_manual_incomplete|> 
  mutate(facility = toupper(facility))

public_manual_incomplete <- public_manual_incomplete |> 
  mutate(facility = toupper(facility))

```

```{r}

priv_not_included <- anti_join(private_manual_incomplete, prisons_hsf, by="hsf_facility_name")
pub_not_included <- anti_join(public_manual_incomplete, prisons_hsf, by="hsf_facility_name")
```

```{r}

#finding missing values in HILFD FacilityID range
setdiff(10000001:	
10007020
, prisons_hsf$V2)
```

#Data Visualization on System-Level Data

```{r}
library(tidyverse)

data <- read_csv("aggregate_data.csv")

ind_cod_dataset <- data %>% 
  select(system, ind_first, ind_last, ind_age, ind_gender, ind_race, ind_deathloc, ind_dod, ind_cod, c_ind_cod_type) %>% 
  count(c_ind_cod_type) 
ind_cod_dataset

ind_cod_dataset %>% 
  ggplot(aes(x = c_ind_cod_type, y = n)) + 
    geom_bar(stat = "identity") +
    geom_text(aes(label = n), vjust = -0.3) +
    labs(title = "Count of Incarcerated Cause of Death Type", x = "Cause of Death Type", y = "Count") + 
    theme_minimal() + 
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1)
    ) + 
    scale_y_continuous(limits = c(0, 3000), breaks = c(500, 1000, 1500, 2000, 2500, 3000))

```

#DCRA required fields(missing data of birth of individuals) 
```{r}
dcra_variables <- c('ind_first', "ind_middle", "ind_last", "ind_gender", "ind_race", "ind_ethnicity", "ind_dod", "ind_tod", "ind_deathloc", "ind_cod", "ind_fachoused")
```

#Missing data percentage based on DCRA required fields
```{r}
#computes the percentage of missing value for each variable across the entire dataset
data %>% 
  summarize(across(everything(), ~mean(is.na(.)) * 100)) %>% #calculates percentage of missing values for each column
  select(ind_first, ind_middle, ind_last, ind_gender, ind_race, ind_ethnicity, ind_dod, ind_tod, ind_deathloc, ind_cod, ind_fachoused) %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "data_percentage") %>% 
  mutate(data_percentage = round(data_percentage, 2)) 
```

#Missing data percentage for each variable by system, based on DCRA required fields
```{r}

data %>% 
  group_by(system) %>% 
  summarize(across(everything(), ~mean(is.na(.)) * 100)) %>% 
  pivot_longer(cols = -system, names_to = "variable", values_to = "data_percentage") %>% 
  mutate(data_percentage = round(data_percentage, 2)) %>% 
  pivot_wider(names_from = system, values_from = data_percentage) %>% 
  subset(variable %in% dcra_variables)
```

#Comprehensive missing data percentage for each variable by system, as well as corresponding systems, based on DCRA required fields 
```{r}
#calculates the percentage of missing data within each system, then computes the percentage of systems where there is 100% missing data for each variable 
comprehensive_percentages <- data %>% 
  group_by(system) %>% 
  summarize(across(everything(), ~sum(is.na(.))/n() * 100)) %>%   #calculates percentage of missing values for each variable for a given system 
  summarize(across(everything(), ~mean(. == 100) * 100)) %>% #calculates percentage of systems that are missing 100% of the data for a given variable 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "comprehensive_percentage") %>% 
  mutate(comprehensive_percentage = round(comprehensive_percentage, 2)) 
comprehensive_percentages

#describes the systems where there is 100% missing data for each variable 
comprehensive_systems <- data %>% 
  group_by(system) %>% 
  summarize(across(everything(), ~all(is.na(.)))) %>% 
  pivot_longer(cols = -system, names_to = "variable", values_to = "comprehensive_data") %>% 
  filter(comprehensive_data) %>% 
  group_by(variable) %>% 
  summarize(systems = paste(system, collapse = ", "))
comprehensive_systems

#join datasets 
missing_data <- full_join(comprehensive_percentages, comprehensive_systems, by = "variable") %>% 
  subset(variable %in% dcra_variables)
missing_data
```
