---
title: "r_webscraping_test"
output: html_document
date: "2024-09-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse) 
library(rvest) 
library(here)
```

#Functions
```{r}
#Webscrapes all HTML tables from website URL 
scrape_table <- function(scrape_url) {
  scrape_page <- scrape_url %>% read_html() 
  
  scrape_table <- scrape_page %>% 
    html_table() %>% 
    map_dfr(~.x) %>% 
    
  return(scrape_table)
}
```

#Mike Example Webscraper
```{r}
#Webscraped URL 
scrape_url = "https://cor.mt.gov/DataStatsContractsPoliciesProcedures/DataPages/DeathsInCustody"

#Read HTML content of URL 
mt_scrape_page = scrape_url %>% 
  read_html()

mt_scrape_tbl <- mt_scrape_page %>% 
  html_table() %>%  # returns all tables 
  map_dfr(~.x) %>%  # walk each table and return it
  set_names(c("ind_dod", "ind_name", "doc_id_num", "location")) %>%  # could also extract from tbl
  filter(ind_dod != "Date of Death", !is.na(ind_dod), ind_dod != "") %>%  # drop known blanks
  mutate(ind_dod_year = ind_dod %>%  mdy() %>%  year()) # create a year var for counting


mt_scrape_tbl
#mt_scrape_tbl |> write_csv("MT_death_scrape_tbl.csv") 
```

#Alabama Executions Webscraper 
```{r}
#Webscraped URL 
scrape_url <- "https://doc.alabama.gov/Executions"

al_scrape_table <- scrape_table(scrape_url) %>% 
  set_names(c("ind_doc_id", "ind_full_name", "ind_race", "ind_gender", "ind_county", "ind_offense", "ind_arrived_deathrow", "ind_dob", "ind_dod", "ind_governor")) %>% 
  mutate(ind_arrived_deathrow = 
           case_when(
             ind_arrived_deathrow == "?" ~ NA, 
             TRUE ~ ind_arrived_deathrow
            ),
         ind_dob =
           case_when(
             ind_dob == "?" ~ NA, 
             grepl("^c\\.\\s*\\d{4}", ind_dob) ~ sub("c\\.\\s*(\\d{4})", "\\1", ind_dob), 
             TRUE ~ ind_dob 
           )
  )
al_scrape_table

#al_scrape_table %>% write_csv(here("data/webscraping_data/alabama_executions.csv"))
```

#Arizona Executions Webscraper
```{r}
#Webscraped URL
scrape_url <- "https://corrections.az.gov/death-row/executions-prior-1992-execution-methods"

az_scrape_table <- scrape_table(scrape_url) %>% 
  set_names(c("ind_doc_id", "ind_name", "ind_ethnicity", "ind_tod", "ind_dod")) %>% 
  filter(ind_doc_id != "ADC#", ind_doc_id != "Death Penalty Inactive April 1962 - April 1992") %>% 
  mutate(ind_tod = 
           case_when(
             ind_tod == "- - - - - -" ~ NA, 
             ind_tod == "- - - - - - -" ~ NA,
             TRUE ~ ind_tod
           )
        )
az_scrape_table

#az_scrape_table %>% write_csv(here("data/webscraping_data/arizona_executions.csv"))
```

#Arkansas Executions Webscraper
```{r}
#Webscraped URL 
scrape_url <- "https://doc.arkansas.gov/correction/inmates/executions/"

ar_scrape_table <- scrape_table(scrape_url) %>% 
  set_names(c("ind_name", "ind_race_gender", "ind_age", "ind_county", "ind_offense", "ind_dod")) %>% 
  filter(ind_name != "NAME") %>% 
  mutate(ind_age = 
           case_when(
             ind_age == "" ~ NA, 
             TRUE ~ ind_age
           )
         )
ar_scrape_table

#ar_scrape_table %>% write_csv(here("data/webscraping_data/arkansas_executions.csv"))
```

#California Executions Webscraper 
```{r}
#Webscraped URL 
scrape_url <- "https://www.cdcr.ca.gov/capital-punishment/inmates-executed-1978-to-present/"

ca_scrape_table <- scrape_table(scrape_url) %>% 
  set_names(c("ind_full_name", "ind_execution_date_received", "ind_dod", "ind_time_on_dr", "ind_age", "ind_date_state_executed")) %>% 
  mutate(ind_dod = case_when(
    !is.na(ind_date_state_executed) ~ sub("\\s*\\(.*\\)", "", ind_date_state_executed),
    TRUE ~ ind_dod 
    ),
    ind_deathloc = case_when(
      !is.na(ind_date_state_executed) ~ sub(".*\\((.*)\\)", "\\1", ind_date_state_executed),
      TRUE ~ NA
    )
  ) %>% 
  select(!ind_date_state_executed)

ca_links <- ca_scrape_page %>% 
  html_nodes("table") %>% 
  html_nodes("a") %>% 
  map_df(~tibble(
    ind_full_name = html_text(.), 
    ind_supplemental_link = html_attr(., "href")
  ))

ca_scrape_table <- ca_scrape_table %>% 
  left_join(ca_links, by = "ind_full_name") %>% 
  select(ind_supplemental_link, everything()) 
ca_scrape_table

#ca_scrape_table %>% write_csv(here("data/webscraping_data/california_executions.csv")) 
```

#Mississippi Executions Webscraper
```{r}
#Webscraped URL 
scrape_url <- "https://www.mdoc.ms.gov/general-public/death-row/death-penalty-mississippi"

ms_scrape_table <- scrape_table(scrape_url) %>% 
  set_names(c("ind_name", "ind_race_gender", "ind_offense", "ind_dod")) %>% 
  separate(ind_race_gender, c("ind_race", "ind_gender"))
ms_scrape_table

#ms_scrape_table %>% write_csv(here("data/webscraping_data/mississippi_executions.csv"))
```

#Montana Individual Deaths Webscraper
```{r}
#Webscraped URL 
scrape_url <- "https://cor.mt.gov/DataStatsContractsPoliciesProcedures/DataPages/DeathsInCustody"

mt_scrape_table <- scrape_table(scrape_url) %>% 
  set_names(c("ind_dod", "ind_name", "ind_doc_id", "ind_deathloc")) %>% 
  filter(ind_dod != "Date of Death", ind_dod != "")
mt_scrape_table

#mt_scrape_table %>% write_csv(here("data/webscraping_data/montana_individual_death.csv"))
```

#Tennessee Executions Webscraper
```{r}
#Webscraped URL 
scrape_url <- "https://www.tn.gov/correction/statistics/executions/tennessee-executions.html"

tn_scrape_table <- scrape_table(scrape_url) %>% 
  select(X1:X5) %>% 
  set_names(c("ind_name", "ind_race", "ind_offense", "ind_county", "ind_dod")) %>% 
  filter(ind_name != "NAME", ind_name != "")
tn_scrape_table

#tn_scrape_table %>% write_csv(here("data/webscraping/tennessee_executions.csv"))
```

#Texas Executions Webscraper 
```{r}
#Webscraped URL 
scrape_url <- "https://www.tdcj.texas.gov/death_row/dr_executed_offenders.html"

tx_scrape_table <- scrape_table(scrape_url) %>% 
  select(!c("Execution", "Link...2", "Link...3")) %>% 
  set_names(c("ind_last", "ind_first", "ind_doc_id", "ind_age", "ind_dod", "ind_race", "ind_county"))

tx_supplemental_inmate_info <- tx_scrape_page %>% 
  html_nodes("table") %>% 
  html_nodes("a") %>% 
  map_df(~tibble(
    ind_supplemental_link = html_attr(., "href")
  )) %>% 
  mutate(ind_supplemental_link = gsub("/death_row/", "", ind_supplemental_link), 
         ind_supplemental_link = paste0("https://www.tdcj.texas.gov/death_row/", ind_supplemental_link)) 

supplemental_table <- lapply(tx_supplemental_inmate_info$ind_supplemental_link, scrape_table) 
supplemental_table



```

#Utah Individual Deaths Webscraper
```{r}
#Webscraped URL 
scrape_url <- "https://corrections.utah.gov/recently-deceased-inmates/"

ut_scrape_table <- scrape_table(scrape_url) %>% 
  set_names(c("ind_name", "ind_doc_id", "ind_dod", "ind_age", "ind_fachoused", "ind_cod")) %>% 
  filter(ind_name != "Name")
ut_scrape_table

#ut_scrape_table %>% write_csv(here("data/webscraping/utah_individual_death.csv"))
```

